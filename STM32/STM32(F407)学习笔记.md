# STM32(F407)学习笔记

**引脚分类：**

![](.\image\引脚分类.png)

## **GPIO说明**

![](.\image\GPIO框图.png)

### **寄存器分类**

#### 端口模式寄存器（GPIOx_MODER)）

输出方式有：（两个比特位）

| 00   | 输入（复位状态）（采用TTL模式，低于1.8v为0；高于1.8v为1） |
| ---- | --------------------------------------------------------- |
| 01   | 通用输出模式                                              |
| 10   | 复用功能模式                                              |
| 11   | 模拟模式                                                  |

#### 端口输出类型寄存器（GPIOx_OTPYPER）

##### 两种输出方式

| 0    | 输出推挽（复位状态） | 正常输出0和1；用于链接数字期间，高电平由VDD决定，低电平由VSS决定<br />其开关效率高，电流大，驱动能力强 |
| ---- | -------------------- | ------------------------------------------------------------ |
| 1    | 输出开漏             | 只能输出0.要输出1必须在IO口外接电源.多用于I2C和SMBUWS总线    |

###### 推挽输出

![](.\image\推挽输出.png)

###### 开漏输出

![](.\image\开漏输出.png)

#### 端口输入数据寄存器(GPIOx_IDR)

#### 端口输出速度寄存器(GPIOx_OSPEEDR)

#### 端口输出数据寄存器(GPIOx_ODR)

#### 端口置位寄存器(GPIOx_BSRR)

#### 端口上拉/下拉寄存器(GPIOx_PUPDR)

​		在GPIO端口中，**电阻上拉**和**电阻下拉**的作用是为了在**GPIO输入模式**下，防止GPIO输入口浮动，从而造成信号干扰的情况。

​		电阻上拉（Pull Up）与电阻下拉（Pull Down）的区别在于起作用的电阻连接的位置。当一个GPIO口设为**输入模式**时，如果这个GPIO口没有外部信号（也就是不接任何器件），那么它的电平就是一个**不确定的**高电平或低电平，也就是所谓的**"浮动"**。为了避免这种情况，一个可供选择的方法就是在这个GPIO口的输入端外加一个足够大的电阻，并通过连接到信号电源电压或地上电压的方式来使得这个GPIO口处于高电平或低电平。

​		**电阻上拉**就是将GPIO口上的电阻连接到一个**电源电压**上（如Vcc），一般用于场景中需要设定**默认输入为高电平**-例如开关常闭模式，选择电阻上拉后那个GPIO口处于高电平就是开。而**电阻下拉**就是将GPIO口上的电阻连接到**地上电压**（GND），一般用于场景中需要**设定默认输入为低电平**-例如开关常开模式，选择电阻下拉后那个GPIO口处于低电平就是开。

### GPIO输出时初始化顺序

1. 开启GPIO端口的时钟。（**stm32的外设都有单独的时钟控制**）
2.  确定GPIO是输入、通用输出、 复用功能还是模拟输入（GPIOx_MODER）
3. 如果是输出还要确定是推挽输出还是开漏输出（GPIOx_OTPYPER
4.  配置输出的速度
5. 输的时候内部的上/下拉电阻要不要开启
6. 具体看输出内容（置位复位寄存器：BSRR和数据输出寄存器：ODR）

## 固件库编程

固件库的目录结构说明

![](.\image\ST标准库目录.png)

在**Libraries\\CMSIS**目录下文件内容：

![](.\image\CMSIS目录结构(Libraries目录下).png)

固件库文件分析：

| 片上外设                                              |                                |
| ----------------------------------------------------- | ------------------------------ |
| startup_stm32f40xx.s                                  | 汇编编写的启动文件             |
| stm32f4xx.h                                           | 寄存器映射                     |
| system_stm32f4xx.h                                    | 初始化系统时钟                 |
| system_stm32f4xx.c                                    | 初始化系统时钟                 |
| stmem_stm32f4xx_xxx.h/stmem_stm32f4xx_xxx.c(片上外设) | 芯片外设的驱动库               |
| **内核**                                              |                                |
| misc.c/misc.h                                         | 实现中断相关的函数             |
| core_cm4.h                                            | 内核寄存器映射                 |
| core_cmFunc.h/core_cmInstr.h/core_cmSimd.h            | 实现对内核外设的一些操作的函数 |
| **中断**                                              |                                |
| stm32f4xx_it.c/stm32f4xx_it.h                         | 用来存放中断服务函数           |
| **用户main**                                          |                                |
| main.c                                                | 用来存放main函数               |

新建固件库工程模板

1. 创建6个文件夹

   | 名称      | 作用                                                         |
   | --------- | ------------------------------------------------------------ |
   | Doc       | 工程说明.txt。 这个文件我们自己手动新建， 可要可不要         |
   | Libraries | 存放的是库文件 （CMSIS：里面放着跟 CM4 内核有关的库文件， 直接从固件库里面拷贝。<br />  STM32F4xx_StdPeriph_Driver： STM32 外设库文件， 直接从固件库里面拷贝） |
   | Listing   | 存放发编译器编译时产生的C/汇编/链接的列表清单。（暂时为空）  |
   | Output    | 存放编译产生的调试信息 hex文件 预览信息 封装库等（暂时为空） |
   | Project   | 用来存放工程                                                 |
   | User      | 用户编写的驱动文件<br />stm32f4xx_conf.h：用来配置库的头文件， 直接从固件库里面拷贝  <br />stm32f4xx_it.h <br />stm32f4xx_it.c：中断相关的函数都在这个文件编写。这两个文件直接从固件库里面拷贝<br />main.c： main 函数文件， 这个文件我们自己手动新建，不用固件库里面<br/>配套的。 |

   